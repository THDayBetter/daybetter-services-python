# Home Assistant Integration Guide

This project exists primarily to power the official DayBetter Services integration that is under review in [home-assistant/core#154677](https://github.com/home-assistant/core/pull/154677).

## Overview

- **Package name:** `daybetter-services-python`
- **Python module:** `daybetter_python`
- **Key entry point:** `DayBetterClient.fetch_sensor_data()`
- **Supported entities:** temperature, humidity, battery sensors (more planned)

## Installation

```bash
pip install daybetter-services-python
```

Home Assistant Core installs the dependency automatically via `manifest.json`.  
For custom component development you can vendor the package or install it in your HA venv using the same command.

## Obtaining Credentials

- **Token**: generated by the DayBetter mobile app (typically the same bearer token that Home Assistant requests from the user).
- **hass_code**: the code shown in the DayBetter app when linking Home Assistant. Codes starting with `db-` automatically trigger the production API endpoint, otherwise the test environment is used.

Neither secret is stored in this repository. The Home Assistant config flow prompts the user and passes them to the library.

## Typical Home Assistant Flow

```python
client = DayBetterClient(token=token, hass_code=hass_code)
sensor_data = await client.fetch_sensor_data()
```

`fetch_sensor_data()` internally:
1. Fetches current device statuses.
2. Fetches device metadata and PID tables (cached for reuse).
3. Filters devices to sensor-only PIDs.
4. Merges status and metadata so the coordinator receives a single payload.

The HA coordinator only needs to schedule this method periodically.

## Example YAML (Custom Component)

```yaml
daybetter_services:
  token: !secret daybetter_token
  hass_code: db-xxxx
  update_interval: 60  # seconds
```

The official integration will instead expose a config flow and store entries in `.storage`. The above example is merely illustrative for reviewers.

## Known Limitations

- Only sensor platform is included in the first PR.
- MQTT live updates, lights, switches and custom services will arrive in future PRs once the minimal integration is merged.
- Token refresh must be handled manually in the DayBetter mobile app today.

## Testing / QA

- Run `pip install -e .[dev]`
- Execute `pytest`, `flake8`, `mypy daybetter_python`
- The GitHub Actions workflow mirrors these steps on `pull_request` and `push` events.

## Contact

- Library issues: [GitHub Issues](https://github.com/THDayBetter/daybetter-services-python/issues)
- Home Assistant PR feedback: comment directly on [core#154677](https://github.com/home-assistant/core/pull/154677)

